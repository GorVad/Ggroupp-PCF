
<html><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <link href="https://cdn.jsdelivr.net/npm/suggestions-jquery@18.8.0/dist/css/suggestions.min.css" type="text/css" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript">
    var customJQ=$.noConflict();
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/suggestions-jquery@18.8.0/dist/js/jquery.suggestions.min.js"></script>
    <script type="text/javascript" src="gg_accountfieldsdadata.js"></script>
<style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style><meta><style type="text/css">P { margin: 0; }</style></head>
<body onfocusout="parent.setEmailRange();" style="overflow-wrap: break-word;">
    <div style="float:left;">
        <input id="party" type="text" size="100">
    </div>
    <div style="float:left;margin-left:5px;">
    </div>
    <script type="text/javascript">
                 
var xrm = parent.Xrm;
var customJQ=jQuery.noConflict();
var API_KEY = "4ca8954e3e3bdc1945c17f4979c1950b390bf569";
var getDadataValue = function (sugg, path) 
	{
	var paths = path.split('.'), current = sugg, i;

	for (i = 0; i < paths.length; ++i) 
		{
			if (current[paths[i]] == undefined) return undefined;
			else current = current[paths[i]];
		}
	return current;
	};
  
    var setAddress=function(suggest){
    debugger;
    if(suggest.suggestions&& suggest.suggestions.length!=0){
        var curSuggest=suggest.suggestions[0];
                    xrm.Page.getAttribute("address2_postalcode").setValue(curSuggest.data.postal_code);
                     xrm.Page.getAttribute("address2_country").setValue(curSuggest.data.country);
                    xrm.Page.getAttribute("address2_city").setValue(curSuggest.data.city);
                    xrm.Page.getAttribute("address2_stateorprovince").setValue(curSuggest.data.region);
                    xrm.Page.getAttribute("address2_line1").setValue("ул. " + curSuggest.data.street + ', д. ' + curSuggest.data.house);
                    if (curSuggest.data.block!=null && curSuggest.data.block_type!=null)
                       {
                       var addrValue = xrm.Page.getAttribute("address2_line1").getValue();
                       xrm.Page.getAttribute("address2_line1").setValue(addrValue + ', ' + curSuggest.data.block_type + '. ' + curSuggest.data.block);
                       }
                    if (curSuggest.data.flat!=null && curSuggest.data.flat_type!=null)
                       {
                       var addrValue = xrm.Page.getAttribute("address2_line1").getValue();
                       xrm.Page.getAttribute("address2_line1").setValue(addrValue + ', ' + curSuggest.data.flat_type + '. ' + curSuggest.data.flat);
                       }
                    xrm.Page.getAttribute("address2_composite").setValue(curSuggest.value);
                    xrm.Page.getAttribute("gg_egruladdress").setValue(curSuggest.value);
                    xrm.Page.getAttribute("gg_kladr_id").setValue(curSuggest.data.region_kladr_id); 
         
    var kladrID = Xrm.Page.getAttribute("gg_kladr_id").getValue();
    var viewId = "{C0F1DD64-1BF3-450D-BCDE-DF4732DE1606}"; // "Генерируем" ID для нового представления
    var entityName = "krs_territory"; // Имя объекта
    var viewDisplayName = "Регионы РФ"; // Задаем название нового представления
    var setDefault = true; // Определяем, будет ли наше новое представление деолтным при открытии диалогового окна лукапа

    // Create the Advanced find query and download the fetch xml
    var fetchXml = "" +
    "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'>" +
        "<entity name='krs_territory'>" +
            "<attribute name='krs_name' />" +
            "<attribute name='krs_territoryid' />" +
            "<order attribute='krs_name' descending='false' />" +
            "<filter type='and'>" +
                "<condition attribute='gg_kladr_id' operator='eq' value='" + kladrID + "'/>" +
            "</filter>" +
        "</entity>" +
    "</fetch>";

    // Определяем представление фильтрованного лукапа
    var layoutXml = "" +
    "<grid name='resultset' object='1' jump='name' select='1' icon='1' preview='1'>" +
        "<row name='result' id='krs_territoryid'>" +
            "<cell name='krs_name' width='100' />" +
            "<cell name='gg_kladr_id' width='100' />" +
        "</row>" +
    "</grid>";

    // Задаем имя лукапа и задаем кастомное Представление для него
    var lookupControl = Xrm.Page.ui.controls.get('krs_territoryid');
    lookupControl.addCustomView(viewId, entityName, viewDisplayName, fetchXml, layoutXml, setDefault);

    // Отключаем смену Представлений в диалоговом окне лукапа
    //document.getElementById("krs_territoryid").disableViewPicker = 1;
    //var primСontact = document.getElementById("krs_territoryid");
    //primСontact.setAttribute("disableViewPicker", "1")


 var territoryAttr = Xrm.Page.getAttribute("krs_territoryid");
        var currentValue = territoryAttr.getValue();

if (currentValue != null) {
            var cols = "krs_federaldistrict";
            var retrievedCampaign = SDK.REST.retrieveRecord(currentValue[0].id, "krs_territory", cols, null, 
function (account) {
ProcessReturnedFlag(account);
},
function (error) {
alert(error.message);
}
);
}
function ProcessReturnedFlag (account) {
                var lookupValue = account.krs_federaldistrict;
                Xrm.Page.getAttribute("krs_federaldistrictid").setValue([{ id: lookupValue.Id, name: lookupValue.Name, entityType: lookupValue.LogicalName }]);
    }              
}

};

function suggest(resource, query) {
  var http = new XMLHttpRequest();
  http.open("POST", "https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/" + resource, true);
  http.setRequestHeader("Content-Type", "application/json");
    http.setRequestHeader("Accept", "application/json");
  http.setRequestHeader("Authorization", "Token " + API_KEY);
    
    http.onreadystatechange = function() {//Вызывает функцию при смене состояния.
    if(http.readyState == XMLHttpRequest.DONE && http.status == 200) {
      setAddress(eval("("+http.responseText+")"));
    }
}

  var data = "{ \"query\": \"" + query + "\" }";
  http.send(data);
}


        customJQ("#party").suggestions({
            token: API_KEY,
            type: "PARTY",
            count: 5,
            /* Вызывается, когда пользователь выбирает одну из подсказок */
            onSelect: function (suggestion) {

                for (var i = 0; i < dadataMapping.length; i++) {
                    var map = dadataMapping[i];
                    var dadataPath = map.dadataPath;
                    var val = getDadataValue(suggestion, dadataPath);
                    
                    if(dadataPath===''){
                    val=map.value;
}

                    if (map.crmAttrName === '') {
                        continue;
                    }
                    
                    if(map.crmAttrName==='gg_egruladdress'&&val&&val!==''){          
                    var address=suggest("address",val);
            
}
else{
                    var attr = xrm.Page.getAttribute(map.crmAttrName);

                    if (attr === null) {
                        alert("На форме отсуттвует атрибут " + map.crmAttrName);

                        return;
                    }
                   
                    if(map.dadataPath=='data.state.status'){
                        if(val&&val!==''){
                        for(var j=0;j<statuscodes.length; j++){
                        if(statuscodes[j].dadata===val){
                        attr.setValue(statuscodes[j].crmVal);
}
}
}
                    
                    }
else{

switch(map.crmAttrName){
case "name":
if(!attr.getValue()){
attr.setValue(val);
}
break;
default:
attr.setValue(val);
}



}

                    attr.setSubmitMode("always");
                    }
                }
                
                var ownTypeAttr=xrm.Page.getAttribute("krs_owntype");
                var pre=suggestion.data.name.short_with_opf.split(' ')[0];
                
                var options=ownTypeAttr.getOptions();
                
                for(var j=0;j<options.length; j++){
                    if(pre===options[j].text){
                    ownTypeAttr.setValue(options[j].value);
                    break;
}
}


  //              xrm.Page.ui.tabs.get("tab_7").setVisible(false);
            }
        });

        function viewDataCall(val) {
            var jParty = customJQ("#party");
            jParty.val(val);
            jParty.on("suggestions-fixdata",
                function (e, suggestion) {
                    console.log(suggestion);
                }
            );
            var jPartyS = jParty.suggestions();

            var timeout = setTimeout(function () {
                jPartyS.fixData();
                jPartyS.update();
            }, 500);
        }

        window.addEventListener('message', function (theEvent) {